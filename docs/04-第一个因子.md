# 第一个因子 - 手把手创建你的第一个因子

恭喜你！现在我们要创建你的第一个因子了。别紧张，我们会一步步指导你，就像学骑自行车一样，从最简单的开始。

## 🎯 准备工作

在开始之前，确保你已经：

1. ✅ 完成了 [环境搭建](./03-环境搭建.md)
2. ✅ 理解了 [核心概念](./02-核心概念理解.md)
3. ✅ MongoDB 数据库已经启动
4. ✅ 数据已经加载到数据库（如果没有，需要先运行数据清洗）

## 🚀 方式一：公式方式（最简单，推荐新手）

公式方式就像用 Excel 写公式，不需要编程基础。

### 步骤 1：理解我们要创建的因子

我们要创建一个**简单的动量因子**：

-   **含义**：计算股票最近 20 天的收益率
-   **逻辑**：如果股票最近涨得多，因子值就高

### 步骤 2：编写公式

```python
# 计算20日收益率
(CLOSE / DELAY(CLOSE, 20)) - 1
```

**公式解释**：

-   `CLOSE`：今天的收盘价
-   `DELAY(CLOSE, 20)`：20 天前的收盘价
-   `CLOSE / DELAY(CLOSE, 20) - 1`：计算收益率（百分比）

### 步骤 3：通过 Web 界面创建

1. **启动服务**

    ```bash
    # 启动 API 服务
    cd panda_factor_server
    python -m panda_factor_server

    # 启动 Web 前端（新开一个终端）
    cd panda_web
    python -m panda_web.main
    ```

2. **打开浏览器**

    - 访问：http://localhost:8080/factor
    - 登录系统

3. **创建因子**

    - 点击"创建因子"按钮
    - 填写信息：
        - **因子名称**：`my_first_factor`
        - **因子中文名**：`我的第一个因子`
        - **代码类型**：选择"公式"
        - **因子代码**：输入上面的公式
        - **因子类型**：选择"stock"（股票因子）
        - **描述**：`计算20日收益率`
    - 点击"保存"

4. **运行因子分析**

    - 找到刚创建的因子
    - 点击"运行分析"
    - 等待分析完成（可能需要几分钟）

5. **查看结果**
    - 分析完成后，点击"查看结果"
    - 你会看到各种图表和指标

### 步骤 4：通过 API 创建（可选）

如果你更喜欢用代码：

```python
import requests

# API 地址
api_url = "http://localhost:8111/api/v1/create_factor"

# 因子数据
factor_data = {
    "user_id": "1",
    "name": "我的第一个因子",
    "factor_name": "my_first_factor",
    "factor_type": "stock",
    "code_type": "formula",
    "code": "(CLOSE / DELAY(CLOSE, 20)) - 1",
    "describe": "计算20日收益率",
    "tags": "动量因子",
    "status": 0,
    "is_persistent": False
}

# 发送请求
response = requests.post(api_url, json=factor_data)
print(response.json())
```

## 🐍 方式二：Python 方式（推荐有编程基础的用户）

Python 方式更灵活，可以表达复杂的逻辑。

### 步骤 1：创建因子类

```python
from panda_factor.generate.factor_base import Factor

class MyFirstFactor(Factor):
    """我的第一个因子

    计算20日收益率，衡量股票的动量。
    """

    def calculate(self, factors):
        # 获取收盘价
        close = factors['close']

        # 计算20日收益率
        # DELAY(close, 20) 表示20天前的收盘价
        returns = (close / self.DELAY(close, 20)) - 1

        return returns
```

### 步骤 2：转换为字符串格式

在 Web 界面创建时，需要将类转换为字符串：

```python
code = """
from panda_factor.generate.factor_base import Factor

class MyFirstFactor(Factor):
    def calculate(self, factors):
        close = factors['close']
        returns = (close / self.DELAY(close, 20)) - 1
        return returns
"""
```

### 步骤 3：创建因子

通过 Web 界面或 API 创建，代码类型选择"python"，代码内容填入上面的字符串。

## 📊 理解你的因子

创建完成后，让我们理解一下这个因子：

### 因子值的含义

-   **因子值 > 0**：股票最近 20 天上涨了
-   **因子值 < 0**：股票最近 20 天下跌了
-   **因子值越大**：上涨幅度越大

### 如何使用

1. **筛选股票**：选择因子值高的股票（最近涨得好的）
2. **构建策略**：买入因子值高的股票，卖出因子值低的股票
3. **评估效果**：查看因子分析报告，看这个策略是否有效

## 🎨 进阶示例：添加排名

让我们改进一下，添加排名功能：

### 公式方式

```python
# 计算20日收益率并排名
RANK((CLOSE / DELAY(CLOSE, 20)) - 1)
```

**改进点**：

-   `RANK()` 函数会将收益率转换成排名
-   排名范围是 -0.5 到 0.5
-   更容易比较不同股票

### Python 方式

```python
from panda_factor.generate.factor_base import Factor

class MyFirstFactor(Factor):
    def calculate(self, factors):
        close = factors['close']

        # 计算20日收益率
        returns = (close / self.DELAY(close, 20)) - 1

        # 添加排名
        ranked = self.RANK(returns)

        return ranked
```

## 🔍 验证因子

创建因子后，如何验证它是否正确？

### 方法 1：查看因子值

```python
import panda_data

panda_data.init()

# 获取因子数据
factor_data = panda_data.get_factor_by_name(
    factor_name="my_first_factor",
    start_date="20240101",
    end_date="20241231"
)

# 查看前几条数据
print(factor_data.head())

# 查看统计信息
print(factor_data.describe())
```

### 方法 2：运行因子分析

在 Web 界面运行因子分析，查看：

-   **IC 值**：应该 > 0（因子值高的股票，未来收益也高）
-   **收益率**：各组的收益率应该有明显差异
-   **图表**：IC 序列图应该整体为正

## 🐛 常见问题

### 问题 1：因子创建失败

**可能原因**：

-   代码语法错误
-   使用了不存在的函数
-   数据未加载

**解决方法**：

-   检查代码语法
-   查看错误日志
-   确保数据已加载

### 问题 2：因子值全是 NaN

**可能原因**：

-   数据不足（没有足够的历史数据）
-   计算逻辑错误

**解决方法**：

-   检查数据是否完整
-   检查 DELAY 函数的参数（20 天需要至少 20 天的历史数据）

### 问题 3：因子分析失败

**可能原因**：

-   因子值全是 NaN
-   数据范围不对
-   参数配置错误

**解决方法**：

-   检查因子值是否有效
-   检查分析参数（日期范围、股票池等）

## 💡 小贴士

1. **从简单开始**：先创建简单的因子，理解原理后再尝试复杂的
2. **多测试**：创建后先在小范围数据上测试
3. **查看示例**：参考系统内置的因子示例
4. **使用 AI 助手**：如果系统集成了 AI 助手，可以询问它如何创建因子

## 🎉 恭喜你！

你已经成功创建了第一个因子！这是一个重要的里程碑。

**下一步**：

-   学习 [因子进阶](./05-因子进阶.md)，创建更复杂的因子
-   学习 [数据分析](./06-数据分析.md)，深入理解因子分析报告

---

**继续你的量化之旅！** 🚀
